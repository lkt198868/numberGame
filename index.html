<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>数字求和游戏</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .target-display {
            font-size: 1.3rem;
            font-weight: bold;
            color: #e74c3c;
        }

        .current-sum {
            font-size: 1.2rem;
            font-weight: bold;
            color: #3498db;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        .check-btn {
            background-color: #27ae60;
        }

        .check-btn:hover {
            background-color: #229954;
        }

        .reset-btn {
            background-color: #e74c3c;
        }

        .reset-btn:hover {
            background-color: #c0392b;
        }

        .numbers-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .number-card {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
        }

        .number-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .number-card.selected {
            background-color: #3498db;
            color: white;
            border-color: #2980b9;
            transform: scale(1.05);
        }

        .message {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message.success {
            background-color: #e8f8f5;
            color: #27ae60;
            border: 1px solid #27ae60;
        }

        .message.error {
            background-color: #fdedec;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }

        .message.info {
            background-color: #e3f2fd;
            color: #3498db;
            border: 1px solid #3498db;
        }

        /* 胜利动画 */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .winner {
            animation: pulse 0.5s ease-in-out 3;
        }

        /* 撒花特效样式 */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 9999;
            pointer-events: none;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            animation: confetti-fall 3s linear forwards;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        @media (max-width: 600px) {
            .numbers-container {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .game-info {
                flex-direction: column;
                gap: 10px;
            }
        }
        /* 烟花特效样式 */
        .firework {
            position: absolute;
            pointer-events: none;
        }

        /* 粒子样式 */
        .firework-particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
        }

        /* 爆炸动画 */
        @keyframes explode {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(0);
            }
            10% {
                opacity: 1;
            }
            70% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: translate(var(--end-x), var(--end-y)) scale(var(--final-scale));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>数字求和游戏</h1>
            <p class="subtitle">选择数字，使它们的和等于目标数字</p>
        </header>

        <div class="game-info">
            <div class="target-display">目标数字: <span id="targetNumber">0</span></div>
            <div class="current-sum">当前和: <span id="currentSum">0</span></div>
        </div>

        <div class="message info" id="message">选择一些数字，使它们的和等于目标数字</div>

        <div class="controls">
            <button id="actionButton">检查答案</button>
        </div>

        <div class="numbers-container" id="numbersContainer">
            <!-- 数字卡片将通过JavaScript动态生成 -->
        </div>
    </div>

    <!-- 撒花特效容器 -->
    <div class="confetti-container" id="confettiContainer"></div>

    <script>
        // 游戏状态
        let targetNumber = 0;
        let previousTargetNumber = -1; // 记录上一次的目标数字，初始化为-1确保与第一次生成的目标数字不同
        let numbers = [];
        let selectedNumbers = [];
        let gameWon = false;
        
        // 回溯算法查找是否存在一组特定数量的数字，其和等于目标数字
        function findSolution(numbers, count, target, result) {
            // 清空结果数组
            result.length = 0;
            
            // 调用回溯函数
            return backtrack(numbers, 0, 0, count, target, [], result);
        }
        
        // 回溯辅助函数
        function backtrack(numbers, startIndex, currentSum, count, target, path, result) {
            // 如果当前路径长度等于要求的数量，且和等于目标，找到解
            if (path.length === count && currentSum === target) {
                // 将找到的解复制到结果数组
                result.push(...path.slice());
                return true;
            }
            
            // 如果路径长度已达到要求或和已经超过目标，停止探索
            if (path.length >= count || currentSum > target) {
                return false;
            }
            
            // 尝试从startIndex开始选择数字
            for (let i = startIndex; i < numbers.length; i++) {
                // 添加当前数字到路径
                path.push(i);
                
                // 递归探索
                if (backtrack(numbers, i + 1, currentSum + numbers[i], count, target, path, result)) {
                    return true; // 找到解，提前返回
                }
                
                // 回溯，移除当前数字
                path.pop();
            }
            
            return false; // 未找到解
        }

        // 撒花特效函数
        function createConfetti() {
            const confettiContainer = document.getElementById('confettiContainer');
            confettiContainer.innerHTML = ''; // 清空之前的撒花
            
            // 创建多种颜色的纸屑
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', 
                           '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50',
                           '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800'];
            
            // 创建100个纸屑
            for (let i = 0; i < 100; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    
                    // 随机位置
                    const leftPosition = Math.random() * 100;
                    confetti.style.left = `${leftPosition}%`;
                    
                    // 随机颜色
                    const colorIndex = Math.floor(Math.random() * colors.length);
                    confetti.style.backgroundColor = colors[colorIndex];
                    
                    // 随机大小
                    const size = Math.random() * 10 + 5;
                    confetti.style.width = `${size}px`;
                    confetti.style.height = `${size}px`;
                    
                    // 随机动画时长
                    const duration = Math.random() * 2 + 2;
                    confetti.style.animationDuration = `${duration}s`;
                    
                    // 随机延迟
                    const delay = Math.random() * 0.5;
                    confetti.style.animationDelay = `${delay}s`;
                    
                    confettiContainer.appendChild(confetti);
                    
                    // 动画结束后移除元素
                    setTimeout(() => {
                        confetti.remove();
                    }, (duration + delay) * 1000);
                }, i * 10); // 每个纸屑延迟10ms出现
            }
        }

        // 烟花特效函数
        function createFireworks() {
            // 定义颜色
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', 
                           '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50',
                           '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800'];
            
            // 获取游戏容器元素
            const gameContainer = document.querySelector('.container');
            const containerRect = gameContainer.getBoundingClientRect();
            
            // 设置游戏容器为相对定位，以便烟花特效基于容器定位
            gameContainer.style.position = 'relative';
            
            // 生成10个烟花
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    // 创建烟花的起始位置（在游戏容器内底部）
                    const startX = Math.random() * (containerRect.width - 40) + 20;
                    const startY = containerRect.height - 20;
                    
                    // 创建烟花的爆炸位置（在游戏容器内上方区域）
                    const explosionX = Math.random() * (containerRect.width - 80) + 40;
                    const explosionY = Math.random() * (containerRect.height * 0.6) + 40; // 爆炸在容器上方60%的区域
                    
                    // 创建烟花元素
                    const firework = document.createElement('div');
                    firework.className = 'firework';
                    firework.style.left = `${startX}px`;
                    firework.style.top = `${startY}px`;
                    
                    // 将烟花添加到游戏容器而不是body
                    gameContainer.appendChild(firework);
                    
                    // 发射动画
                    let startTime = null;
                    const duration = Math.random() * 0.5 + 0.5; // 发射动画持续0.5-1秒
                    
                    function animate(timestamp) {
                        if (!startTime) startTime = timestamp;
                        const progress = Math.min((timestamp - startTime) / (duration * 1000), 1);
                        
                        // 计算当前位置（使用easeOut动画效果）
                        const easeOutProgress = 1 - Math.pow(1 - progress, 3);
                        const currentX = startX + (explosionX - startX) * easeOutProgress;
                        const currentY = startY + (explosionY - startY) * easeOutProgress;
                        
                        // 更新位置
                        firework.style.left = `${currentX}px`;
                        firework.style.top = `${currentY}px`;
                        
                        if (progress < 1) {
                            requestAnimationFrame(animate);
                        } else {
                            // 爆炸效果
                            explodeFirework(currentX, currentY);
                            
                            // 移除发射轨迹
                            firework.remove();
                        }
                    }
                    
                    // 开始动画
                    requestAnimationFrame(animate);
                    
                }, i * 300); // 每个烟花延迟300ms发射
            }
        }
        
        // 爆炸效果
        function explodeFirework(x, y) {
            // 定义颜色
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', 
                           '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50',
                           '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800'];
            
            // 随机选择一种主颜色
            const mainColor = colors[Math.floor(Math.random() * colors.length)];
            
            // 生成50-80个爆炸粒子 (增加粒子数量使爆炸更明显)
            const particleCount = Math.floor(Math.random() * 31) + 50;
            
            // 为了让爆炸更自然，分批次发射粒子
            for (let i = 0; i < particleCount; i++) {
                setTimeout(() => {
                    // 随机选择一个颜色，60%概率使用主颜色，40%概率使用其他颜色
                    const color = Math.random() < 0.6 ? mainColor : colors[Math.floor(Math.random() * colors.length)];
                    
                    // 随机生成爆炸角度和距离
                    const angle = Math.random() * Math.PI * 2;
                    const distance = Math.random() * 100 + 50; // 粒子飞散距离50-150px
                    
                    // 计算结束位置
                    const endX = Math.cos(angle) * distance;
                    const endY = Math.sin(angle) * distance + (Math.random() * 30 - 15); // 添加一些垂直随机性
                    
                    // 创建粒子元素
                    const particle = document.createElement('div');
                    particle.className = 'firework-particle';
                    particle.style.left = `${x}px`;
                    particle.style.top = `${y}px`;
                    
                    // 随机粒子大小
                    const size = Math.random() * 5 + 2; // 2-7px
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    particle.style.backgroundColor = color;
                    
                    // 随机粒子动画持续时间
                    const duration = Math.random() * 0.8 + 0.7; // 0.7-1.5秒
                    
                    // 设置CSS变量用于动画
                    particle.style.setProperty('--end-x', `${endX}px`);
                    particle.style.setProperty('--end-y', `${endY}px`);
                    particle.style.setProperty('--final-scale', Math.random() * 0.5 + 0.5); // 最终缩放
                    
                    // 设置动画
                    particle.style.animation = `explode ${duration}s forwards ease-out`;
                    
                    // 添加到游戏容器而不是body
                    const gameContainer = document.querySelector('.container');
                    gameContainer.appendChild(particle);
                    
                    // 动画结束后移除粒子
                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.remove();
                        }
                    }, duration * 1000);
                    
                    // 小概率在粒子移动过程中创建二次爆炸
                    if (Math.random() < 0.1) { // 10%概率产生二次爆炸
                        setTimeout(() => {
                            createSecondaryBurst(x + endX * 0.6, y + endY * 0.6, color);
                        }, duration * 1000 * 0.6);
                    }
                }, i * 5); // 每个粒子间隔5ms发射，形成连续爆炸效果
            }
        }
        
        // 二次爆炸效果
        function createSecondaryBurst(x, y, color) {
            // 为二次爆炸创建8个更小的粒子
            for (let i = 0; i < 8; i++) {
                const angle = (Math.PI * 2 / 8) * i + Math.random() * 0.5;
                const distance = Math.random() * 30 + 20;
                const endX = Math.cos(angle) * distance;
                const endY = Math.sin(angle) * distance;
                
                const particle = document.createElement('div');
                particle.className = 'firework-particle';
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                
                const size = Math.random() * 3 + 1; // 1-4px
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.backgroundColor = color;
                
                const duration = Math.random() * 0.4 + 0.3; // 0.3-0.7秒
                
                particle.style.setProperty('--end-x', `${endX}px`);
                particle.style.setProperty('--end-y', `${endY}px`);
                particle.style.setProperty('--final-scale', Math.random() * 0.5);
                
                particle.style.animation = `explode ${duration}s forwards ease-out`;
                
                const gameContainer = document.querySelector('.container');
                gameContainer.appendChild(particle);
                
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.remove();
                    }
                }, duration * 1000);
            }
        }

        // 初始化游戏
        function initGame() {
            // 重置游戏状态
            selectedNumbers = [];
            gameWon = false;
            
            // 生成目标数字 (5-10)，确保与上一次不同
            do {
                targetNumber = Math.floor(Math.random() * 6) + 5;
            } while (targetNumber === previousTargetNumber);
            
            // 更新上一次的目标数字为当前目标数字
            previousTargetNumber = targetNumber;
            
            // 生成随机数字组 (6-9个数字，范围2-9，且不包含目标数字)
            const count = Math.floor(Math.random() * 4) + 6; // 6-9个数字
            numbers = [];
            
            for (let i = 0; i < count; i++) {
                let num;
                do {
                    num = Math.floor(Math.random() * 8) + 2; // 2-9的随机数
                } while (num === targetNumber); // 确保不等于目标数字
                numbers.push(num);
            }
            
            // 确保至少有一个解：随机选择2-4个数字的和作为目标（现在目标已确定，要确保数字中存在解）
            const solutionIndices = [];
            
            // 检查是否存在一组数字的和等于目标数字
            let hasSolution = false;
            let attempts = 0;
            
            // 尝试生成一个解，如果没有找到解，则重新生成数字
            while (!hasSolution && attempts < 10) {
                // 尝试找到2-4个数字的组合，和等于目标数字
                for (let numCount = 2; numCount <= 4 && !hasSolution; numCount++) {
                    // 使用回溯法查找是否有解
                    hasSolution = findSolution(numbers, numCount, targetNumber, solutionIndices);
                }
                
                // 如果没有解，重新生成数字
                if (!hasSolution) {
                    numbers = [];
                    for (let i = 0; i < count; i++) {
                        let num;
                        do {
                            num = Math.floor(Math.random() * 8) + 2; // 2-9的随机数
                        } while (num === targetNumber); // 确保不等于目标数字
                        numbers.push(num);
                    }
                }
                
                attempts++;
            }
            
            // 如果仍然没有找到解，添加一些更可能形成解的数字
            if (!hasSolution) {
                // 添加两个较小的数字，使它们的和等于目标数字
                const num1 = Math.floor(Math.random() * (targetNumber - 3)) + 2; // 2到(targetNumber-2)的随机数
                const num2 = targetNumber - num1;
                
                // 确保两个数字都符合要求
                if (num2 >= 2 && num2 <= 9 && num2 !== targetNumber) {
                    // 移除两个现有的数字并添加这两个新数字
                    numbers.splice(0, 2);
                    numbers.push(num1, num2);
                }
            }
            
            // 设置最终目标数字
            // targetNumber已经在上面计算好了，不需要额外赋值
            
            // 显示游戏信息
            document.getElementById('targetNumber').textContent = targetNumber;
            document.getElementById('currentSum').textContent = '0';
            
            // 创建数字卡片
            const container = document.getElementById('numbersContainer');
            container.innerHTML = '';
            
            numbers.forEach((number, index) => {
                const card = document.createElement('div');
                card.className = 'number-card';
                card.textContent = number;
                card.dataset.index = index;
                card.dataset.value = number;
                
                // 添加点击和触摸事件处理
                const handleCardInteraction = function() {
                    if (gameWon) return;
                    
                    if (this.classList.contains('selected')) {
                        // 取消选择
                        this.classList.remove('selected');
                        const idx = selectedNumbers.indexOf(index);
                        if (idx > -1) {
                            selectedNumbers.splice(idx, 1);
                        }
                    } else {
                        // 选择数字
                        this.classList.add('selected');
                        selectedNumbers.push(index);
                    }
                    
                    updateCurrentSum();
                };
                
                // 添加点击事件（桌面端）
                card.addEventListener('click', handleCardInteraction);
                
                // 添加触摸事件（移动端）
                card.addEventListener('touchstart', function(e) {
                    e.preventDefault(); // 防止触摸事件触发点击事件
                    handleCardInteraction.call(this);
                }, { passive: false });
                
                container.appendChild(card);
            });
            
            // 重置消息
            updateMessage('选择一些数字，使它们的和等于目标数字', 'info');
        }

        // 更新当前和
        function updateCurrentSum() {
            let sum = 0;
            for (const index of selectedNumbers) {
                sum += numbers[index];
            }
            
            document.getElementById('currentSum').textContent = sum;
            
            // 如果当前和等于目标数字，显示成功消息
            // if (sum === targetNumber && selectedNumbers.length > 0) {
            //     // updateMessage('太棒了！你找到了正确的组合！点击"检查答案"确认', 'success');
            // } else 
            if (sum > targetNumber) {
                updateMessage('当前和已经超过目标数字，请取消选择一些数字', 'error');
            } else {
                updateMessage('继续选择数字，使它们的和等于目标数字', 'info');
            }
        }

        // 更新消息
        function updateMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
        }

        // 处理按钮点击
        function handleAction() {
            if (gameWon) {
                // 如果游戏已胜利，点击"再来一次"则重置游戏
                resetGame();
            } else {
                // 否则检查答案
                checkSolution();
            }
        }

        // 检查答案
        function checkSolution() {
            let sum = 0;
            for (const index of selectedNumbers) {
                sum += numbers[index];
            }
            
            if (sum === targetNumber && selectedNumbers.length > 0) {
                // 成功
                gameWon = true;
                updateMessage('恭喜你！你赢了！🎉', 'success');
                
                // 添加胜利动画
                document.querySelector('.container').classList.add('winner');
                
                // 随机选择一个特效（撒花或烟花）
                if (Math.random() > 0.5) {
                    // 触发撒花特效
                    createConfetti();
                } else {
                    // 触发烟花特效
                    createFireworks();
                }
                
                // 更改按钮文本为"再来一次"
                document.getElementById('actionButton').textContent = '再来一次';
                
                // 移除动画类
                setTimeout(() => {
                    document.querySelector('.container').classList.remove('winner');
                }, 1500);
            } else if (selectedNumbers.length === 0) {
                // 失败 - 没有选择数字
                updateMessage('请至少选择一个数字', 'error');
            } else {
                // 失败 - 和不相等
                updateMessage(`当前和是 ${sum}，不等于目标数字 ${targetNumber}，请继续尝试`, 'error');
            }
        }

        // 重置游戏
        function resetGame() {
            // 重置按钮文本
            document.getElementById('actionButton').textContent = '检查答案';
            
            // 初始化新游戏
            initGame();
        }

        // 页面加载时初始化游戏
        window.onload = function() {
            initGame();
            
            // 为按钮添加点击和触摸事件监听器
            const actionButton = document.getElementById('actionButton');
            
            // 添加点击事件（桌面端）
            actionButton.addEventListener('click', handleAction);
            
            // 添加触摸事件（移动端）
            actionButton.addEventListener('touchstart', function(e) {
                e.preventDefault(); // 防止触摸事件触发点击事件
                handleAction();
            }, { passive: false });
        };
    </script>
</body>
</html>